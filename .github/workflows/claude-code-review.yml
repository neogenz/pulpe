name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize]
    paths:
      - 'frontend/**/*.ts'
      - 'frontend/**/*.html'
      - 'frontend/**/*.scss'
      - 'backend-nest/**/*.ts'
      - 'shared/**/*.ts'
      - 'supabase/**/*.sql'

jobs:
  claude-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Claude Code Review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            Tu es un expert code reviewer Angular 20+ / NestJS pour le projet Pulpe.

            ## CONTEXTE PR
            - Repository: ${{ github.repository }}
            - PR: #${{ github.event.pull_request.number }}
            - Titre: ${{ github.event.pull_request.title }}

            ## √âTAPES OBLIGATOIRES
            1. Lis CLAUDE.md et .claude/rules/ pour les standards du projet
            2. Lis memory-bank/SPECS.md pour les r√®gles m√©tier
            3. Ex√©cute `gh pr diff ${{ github.event.pull_request.number }}` pour voir les changements
            4. Poste ta review avec cette commande EXACTE:
               ```
               gh pr comment ${{ github.event.pull_request.number }} --body "CONTENU_DE_TA_REVIEW"
               ```

            ## CHECKLIST DE REVIEW

            ### Architecture (5-layer pattern)
            - [ ] Pas d'import cross-feature (features isol√©es)
            - [ ] D√©pendances: core ‚Üê layout/feature/pattern, ui ‚Üê layout/feature/pattern
            - [ ] Backend: controller ‚Üí service ‚Üí mapper (pas de logique dans controller)

            ### Angular 20+ (frontend/)
            - [ ] Composants standalone avec OnPush
            - [ ] Signals: signal(), computed(), linkedSignal() (PAS effect() pour derived state)
            - [ ] Resources: httpResource() pour GET, rxResource() pour complexe
            - [ ] RxJS: takeUntilDestroyed() obligatoire sur tout subscribe()
            - [ ] Inputs: input() au lieu de @Input()

            ### NestJS (backend-nest/)
            - [ ] DTOs valid√©s avec class-validator
            - [ ] AuthGuard avec @User() decorator
            - [ ] Pas de logique m√©tier dans les controllers

            ### TypeScript (shared/)
            - [ ] Zod schemas = source de v√©rit√© API
            - [ ] Pas de `any`, utiliser `unknown` + type guards
            - [ ] Types stricts, pas d'assertions `as` injustifi√©es

            ### S√©curit√©
            - [ ] Pas de secrets hardcod√©s
            - [ ] JWT requis sur tous les endpoints
            - [ ] RLS: WHERE auth.uid() = user_id sur toutes les tables user

            ### Qualit√© Code
            - [ ] Fonctions ‚â§ 30 lignes
            - [ ] Fichiers ‚â§ 300 lignes
            - [ ] Param√®tres ‚â§ 5
            - [ ] Noms descriptifs (pas de x, temp, data)
            - [ ] Booleans pr√©fix√©s: is, has, should, can

            ### R√®gles M√©tier (memory-bank/SPECS.md)
            - [ ] Calculs financiers c√¥t√© serveur uniquement
            - [ ] Rollover = ending_balance du mois pr√©c√©dent
            - [ ] Template propagation: jamais sur mois pass√©s
            - [ ] Lignes `is_manually_adjusted = true` jamais modifi√©es
            - [ ] Atomicit√©: all-or-nothing sur cr√©ation budget/import transactions

            ### Scripts DB (supabase/)
            - [ ] Migrations idempotentes (IF NOT EXISTS)
            - [ ] RLS policies sur nouvelles tables
            - [ ] Pas de DROP sans IF EXISTS
            - [ ] Pas de donn√©es de test en production

            ## FORMAT DE SORTIE

            ### üö® CRITIQUE (bloquant)
            `fichier:ligne` - Description + fix concret

            ### ‚ö†Ô∏è IMPORTANT (√† corriger)
            `fichier:ligne` - Description + fix concret

            ### ‚ÑπÔ∏è SUGGESTION (optionnel)
            `fichier:ligne` - Description + am√©lioration propos√©e

            ---
            **Verdict:** ‚úÖ APPROVE | ‚ùå NEEDS FIX (X critique, Y important)

            Max 10 issues. R√©ponse en fran√ßais.

          claude_args: |
            --max-turns 30
            --model claude-opus-4-5-20251101
            --allowedTools "Bash(gh:*),Read,Glob"
