name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize]
    paths:
      - 'frontend/**/*.ts'
      - 'frontend/**/*.html'
      - 'frontend/**/*.scss'
      - 'backend-nest/**/*.ts'
      - 'shared/**/*.ts'
      - 'supabase/**/*.sql'

jobs:
  claude-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 1

      - name: Claude Code Review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          track_progress: true
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number }}

            Tu es un expert code reviewer Angular 20+ / NestJS. Analyse le diff et poste ta review.

            ## CHECKLIST

            **Angular 20+**: standalone OnPush, signals (signal/computed/linkedSignal), httpResource() pour GET, takeUntilDestroyed() sur subscribe(), input() pas @Input()

            **NestJS**: DTOs valid√©s class-validator, AuthGuard + @User(), pas de logique dans controllers

            **TypeScript**: Zod schemas, pas de `any`, types stricts

            **S√©curit√©**: pas de secrets hardcod√©s, JWT requis, RLS sur tables user

            **Qualit√©**: fonctions ‚â§30 lignes, fichiers ‚â§300 lignes, noms descriptifs

            **DB**: migrations idempotentes (IF NOT EXISTS), RLS policies

            ## OUTPUT
            - Commentaires inline pour issues sp√©cifiques
            - UN commentaire g√©n√©ral avec:

            ### üö® CRITIQUE (bloquant)
            `fichier:ligne` - Description + fix

            ### ‚ö†Ô∏è IMPORTANT
            `fichier:ligne` - Description + fix

            ### ‚ÑπÔ∏è SUGGESTION
            `fichier:ligne` - Am√©lioration

            **Verdict:** ‚úÖ APPROVE | ‚ùå NEEDS FIX

            Max 10 issues. Fran√ßais.

          claude_args: |
            --max-turns 50
            --model claude-sonnet-4-5-20250929
            --allowedTools "mcp__github_inline_comment__create_inline_comment,Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*)"
