name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize]
    paths:
      - 'frontend/**'
      - 'backend-nest/**'
      - 'shared/**'
      - 'supabase/**'
      - 'landing/**'
      - 'ios/**'

jobs:
  claude-review:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read
      pull-requests: write
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Build dynamic review prompt
        id: prompt
        run: |
          set -e

          CHANGED_FILES=$(gh pr diff ${{ github.event.pull_request.number }} --name-only) || {
            echo "ERROR: Failed to get PR diff"
            exit 1
          }

          if [[ -z "$CHANGED_FILES" ]]; then
            echo "WARNING: No files changed in PR"
          fi

          echo "Changed files:"
          echo "$CHANGED_FILES"

          # Build dynamic prompt with only relevant stack checklists
          PROMPT="# Code Review - PR #${{ github.event.pull_request.number }}

          Tu es un expert code reviewer. Analyse UNIQUEMENT les fichiers modifi√©s.

          ## Checklist"

          # Angular 21 (frontend/)
          if echo "$CHANGED_FILES" | grep -q "^frontend/"; then
            PROMPT+="

          ### Angular 21 / Material 21 / Tailwind v4
          - \`changeDetection: ChangeDetectionStrategy.OnPush\` obligatoire
          - Signals: \`signal()\`, \`computed()\`, \`linkedSignal()\` - pas d'observables pour le state
          - \`input()\` et \`output()\` functions (pas @Input/@Output decorators)
          - \`httpResource()\` pour GET async (pas HttpClient.get direct)
          - \`takeUntilDestroyed()\` sur tous les \`subscribe()\`
          - Control flow natif: \`@if\`, \`@for\`, \`@switch\` (pas *ngIf/*ngFor)
          - \`inject()\` pour DI (pas constructor injection)
          - \`host: {}\` pour bindings (pas @HostBinding/@HostListener)
          - JAMAIS \`::ng-deep\`, JAMAIS \`ngClass\`/\`ngStyle\`
          - JAMAIS \`standalone: true\` (d√©faut en v21)
          - Accessibilit√©: WCAG AA, focus management, ARIA"
          fi

          # NestJS 11 (backend-nest/)
          if echo "$CHANGED_FILES" | grep -q "^backend-nest/"; then
            PROMPT+="

          ### NestJS 11 / Bun / Zod 4
          - DTOs valid√©s avec \`createZodDto()\` de nestjs-zod
          - \`@AuthGuard()\` + \`@User()\` decorator sur routes prot√©g√©es
          - Logique m√©tier dans services (controllers = routing + validation)
          - Mappers pour transformation DTO ‚Üî Entity (snake_case ‚Üî camelCase)
          - Gestion d'erreurs structur√©e avec filtres globaux
          - Logging Pino: error(5xx), warn(4xx), info(business), debug(dev)
          - JAMAIS exposer les types DB dans les r√©ponses API
          - JAMAIS de \`any\` - utiliser \`unknown\` si incertain"
          fi

          # Next.js 15 / React 19 (landing/)
          if echo "$CHANGED_FILES" | grep -q "^landing/"; then
            PROMPT+="

          ### Next.js 15 / React 19 / Tailwind v4
          - App Router obligatoire (pas Pages Router)
          - Server Components par d√©faut, \`'use client'\` uniquement si interactivit√©
          - \`next/image\` avec dimensions explicites
          - Metadata API pour SEO (\`generateMetadata\`)
          - Data fetching c√¥t√© serveur (pas useEffect pour fetch)
          - \`loading.tsx\` et \`error.tsx\` pour UX
          - Pas de \`useEffect\` pour data fetching initial"
          fi

          # iOS 17+ / Swift 6 (ios/)
          if echo "$CHANGED_FILES" | grep -q "^ios/"; then
            PROMPT+="

          ### iOS 17+ / Swift 6 / SwiftUI
          - \`@Observable\` macro (JAMAIS \`ObservableObject\`/\`@Published\`)
          - \`async/await\` partout (pas de completion handlers)
          - \`actor\` pour services thread-safe
          - Tous les models sont \`Sendable\`
          - \`NavigationStack(path:)\` avec destinations typ√©es
          - Sheet-based forms avec completion callback
          - JAMAIS de force unwrap \`!\` sans justification
          - Constructor injection avec \`.shared\` defaults"
          fi

          # Shared (shared/)
          if echo "$CHANGED_FILES" | grep -q "^shared/"; then
            PROMPT+="

          ### Shared / Zod 4
          - Schemas Zod bien typ√©s avec inf√©rence
          - Exports coh√©rents et document√©s
          - Pas de d√©pendances circulaires
          - Compatibilit√© frontend + backend"
          fi

          # Supabase (supabase/)
          if echo "$CHANGED_FILES" | grep -q "^supabase/"; then
            PROMPT+="

          ### Supabase / PostgreSQL
          - Migrations idempotentes (\`IF NOT EXISTS\`, \`OR REPLACE\`)
          - RLS policies sur toutes les tables avec \`user_id\`
          - Index sur colonnes fr√©quemment filtr√©es
          - Pas de \`CASCADE\` sans justification"
          fi

          PROMPT+="

          ## R√®gles transversales
          - S√©curit√©: pas de secrets hardcod√©s, JWT requis, validation inputs
          - Qualit√©: fonctions ‚â§30 lignes, fichiers ‚â§300 lignes
          - Nommage: descriptif, coh√©rent avec le domaine m√©tier
          - TypeScript strict: pas de \`any\`, pas de \`as\` cast sans justification

          ## Format de sortie (OBLIGATOIRE)

          Utilise EXACTEMENT ce format markdown:

          \`\`\`
          ## Review PR #${{ github.event.pull_request.number }}

          ### üö® Critiques (bloquants)
          - \`fichier.ts:42\` - Description du probl√®me
            > Suggestion de fix

          ### ‚ö†Ô∏è Importants
          - \`fichier.ts:15\` - Description du probl√®me
            > Suggestion de fix

          ### üí° Suggestions
          - \`fichier.ts:88\` - Am√©lioration possible
            > Suggestion

          ---
          **Verdict:** ‚úÖ APPROVE | ‚ùå CHANGES REQUESTED
          **Fichiers review√©s:** X fichiers
          \`\`\`

          R√®gles:
          - Max 10 issues total
          - En fran√ßais
          - UN SEUL commentaire g√©n√©ral (pas de commentaires inline multiples)
          - Si aucun probl√®me: juste le verdict avec f√©licitations"

          # Output using heredoc for multiline
          echo "review_prompt<<EOF" >> $GITHUB_OUTPUT
          echo "$PROMPT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Claude Code Review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: ${{ steps.prompt.outputs.review_prompt }}
          claude_args: |
            --max-turns 15
            --model claude-sonnet-4-5-20250929
            --allowedTools "Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh pr files:*)"
