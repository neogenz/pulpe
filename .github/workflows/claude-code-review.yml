name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize]
    paths:
      - 'frontend/**/*.ts'
      - 'frontend/**/*.html'
      - 'frontend/**/*.scss'
      - 'backend-nest/**/*.ts'
      - 'shared/**/*.ts'

jobs:
  claude-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Claude Code Review
        uses: anthropics/claude-code-action@beta
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          direct_prompt: |
            # Angular 21+ / NestJS Monorepo Expert Review

            Read CLAUDE.md and .claude/rules/ for project standards. You are an expert on THIS codebase.

            Review ONLY PR changes. Apply these project rules strictly:

            **üö® CRITICAL (block merge):**
            - Angular 21+ violations: deprecated APIs, missing OnPush, signals misuse
            - Cross-feature imports (features must be isolated)
            - Security: XSS, secrets, injection, unsafe DOM
            - TypeScript: `any` usage, `as` instead of type guards, missing null checks
            - Functions >30 lines, files >300 lines, params >5

            **‚ö†Ô∏è IMPORTANT:**
            - Signals anti-patterns: `effect()` for derived state (use `computed()`), mutable signals
            - RxJS subscriptions without cleanup (`takeUntilDestroyed`)
            - Performance: heavy change detection, ngrx effects leaks
            - Missing tests for changed logic
            - `::ng-deep` usage (forbidden)

            **‚ÑπÔ∏è SUGGESTION:**
            - Naming conventions (verbs for actions, is/has/should for booleans)
            - Import organization (Angular ‚Üí ecosystem ‚Üí third-party ‚Üí aliases)

            **Format:** Single comment, grouped by severity, `file:line` + fix. Max 10 issues.
            End with: ‚úÖ APPROVE or ‚ùå NEEDS FIX (X critical, Y important)

            Respond in French if PR is in French.
          model: "claude-sonnet-4-5-20250929"
          max_turns: "10"
