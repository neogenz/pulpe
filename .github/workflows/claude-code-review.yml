name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize]
    paths:
      - 'frontend/**'
      - 'backend-nest/**'
      - 'shared/**'
      - 'supabase/**'
      - 'landing/**'
      - 'ios/**'
      - 'CLAUDE.md'
      - '.claude/**'

jobs:
  claude-review:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read
      pull-requests: write
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Build dynamic review prompt
        id: prompt
        run: |
          set -e

          CHANGED_FILES=$(gh pr diff ${{ github.event.pull_request.number }} --name-only) || {
            echo "ERROR: Failed to get PR diff"
            exit 1
          }

          if [[ -z "$CHANGED_FILES" ]]; then
            echo "WARNING: No files changed in PR"
          fi

          echo "Changed files:"
          echo "$CHANGED_FILES"

          # Build dynamic prompt with only relevant stack checklists
          PROMPT="# Code Review - PR #${{ github.event.pull_request.number }}

          Tu es un expert code reviewer. Analyse UNIQUEMENT les fichiers modifi√©s.

          ## Checklist"

          # Angular 21 (frontend/)
          if echo "$CHANGED_FILES" | grep -q "^frontend/"; then
            PROMPT+="

          ### Angular 21 / Material 21 / Tailwind v4

          **Architecture (CRITIQUE):**
          - \`core/\`: services, guards, interceptors - JAMAIS de composants
          - \`ui/\`: composants stateless r√©utilisables - JAMAIS inject de services
          - \`feature/\`: domaines m√©tier lazy-loaded - isolation totale entre siblings
          - \`pattern/\`: composants stateful r√©utilisables cross-feature
          - JAMAIS d'import entre features siblings (extraire vers core/ui/pattern)
          - Components = d√©l√©gation aux services (logic-free)
          - \`loadChildren\` vers \`.routes.ts\` (pas loadComponent)

          **API Angular:**
          - \`changeDetection: OnPush\` obligatoire
          - Signals: \`signal()\`, \`computed()\`, \`linkedSignal()\`
          - \`input()\`/\`output()\` (pas @Input/@Output)
          - \`httpResource()\` pour GET, \`inject()\` pour DI
          - \`@if\`/\`@for\`/\`@switch\` (pas *ngIf/*ngFor)
          - \`host: {}\` (pas @HostBinding/@HostListener)
          - JAMAIS: \`::ng-deep\`, \`ngClass\`, \`ngStyle\`, \`standalone: true\`
          - Accessibilit√©: WCAG AA, focus, ARIA"
          fi

          # NestJS 11 (backend-nest/)
          if echo "$CHANGED_FILES" | grep -q "^backend-nest/"; then
            PROMPT+="

          ### NestJS 11 / Bun / Zod 4

          **Architecture par Feature (CRITIQUE):**
          - \`common/\`: infrastructure partag√©e (guards, filters, interceptors, decorators, exceptions)
          - \`modules/[domain]/\`: feature folders par domaine m√©tier
          - Structure: \`controller.ts\` ‚Üí \`service.ts\` ‚Üí \`repository.ts\` ‚Üí DB
          - Layers: Controller (routing/validation) ‚Üí Service (logique) ‚Üí Repository (data access)
          - Mappers: DTO ‚Üî Entity (camelCase ‚Üî snake_case)
          - JAMAIS exposer types \`Database['...']['Row']\` dans r√©ponses API

          **Patterns:**
          - DTOs: \`createZodDto()\` + schemas de \`pulpe-shared\`
          - Auth: \`@AuthGuard()\` + \`@User()\` sur routes prot√©g√©es
          - Errors: BusinessException, filtres globaux
          - Logging Pino: error(5xx), warn(4xx), info(business)
          - JAMAIS de \`any\` - \`unknown\` si incertain"
          fi

          # Next.js 15 / React 19 (landing/)
          if echo "$CHANGED_FILES" | grep -q "^landing/"; then
            PROMPT+="

          ### Next.js 15 / React 19 / Tailwind v4
          - App Router obligatoire (pas Pages Router)
          - Server Components par d√©faut, \`'use client'\` uniquement si interactivit√©
          - \`next/image\` avec dimensions explicites
          - Metadata API pour SEO (\`generateMetadata\`)
          - Data fetching c√¥t√© serveur (pas useEffect pour fetch)
          - \`loading.tsx\` et \`error.tsx\` pour UX
          - Pas de \`useEffect\` pour data fetching initial"
          fi

          # iOS 17+ / Swift 6 (ios/)
          if echo "$CHANGED_FILES" | grep -q "^ios/"; then
            PROMPT+="

          ### iOS 17+ / Swift 6 / SwiftUI

          **Architecture (CRITIQUE):**
          - \`App/\`: entry point + AppState - JAMAIS de logique m√©tier
          - \`Core/\`: services = \`actor\` (thread-safe), infrastructure
          - \`Domain/\`: models \`Sendable\`, services wrappent APIClient
          - \`Features/\`: Views + ViewModels, sheets pour forms
          - \`Shared/\`: composants r√©utilisables, extensions, formatters
          - JAMAIS m√©langer UI dans Domain layer

          **Patterns:**
          - \`@Observable\` (JAMAIS ObservableObject/@Published)
          - \`async/await\` (JAMAIS completion handlers)
          - \`NavigationStack(path:)\` avec destinations typ√©es
          - Constructor injection avec \`.shared\` defaults
          - JAMAIS force unwrap \`!\` sans justification"
          fi

          # Shared (shared/)
          if echo "$CHANGED_FILES" | grep -q "^shared/"; then
            PROMPT+="

          ### Shared / Zod 4 - Contrats API

          **R√¥le (CRITIQUE):**
          - Contrats API entre backend NestJS et frontend Angular
          - Source unique de v√©rit√© pour les types √©chang√©s
          - Validation runtime c√¥t√© backend ET frontend

          **Patterns:**
          - Schema + type inf√©r√©: \`export const xSchema = z.object({...}); export type X = z.infer<typeof xSchema>;\`
          - Documenter les r√®gles m√©tier en JSDoc (cf. SPECS.md)
          - Nommage: \`entitySchema\`, \`entityCreateSchema\`, \`entityUpdateSchema\`
          - JAMAIS de d√©pendances externes (sauf zod)
          - JAMAIS de logique m√©tier (seulement validation)"
          fi

          # Supabase (supabase/)
          if echo "$CHANGED_FILES" | grep -q "^supabase/"; then
            PROMPT+="

          ### Supabase / PostgreSQL
          - Migrations idempotentes (\`IF NOT EXISTS\`, \`OR REPLACE\`)
          - RLS policies sur toutes les tables avec \`user_id\`
          - Index sur colonnes fr√©quemment filtr√©es
          - Pas de \`CASCADE\` sans justification"
          fi

          # Tests (*.spec.ts, *.test.ts)
          if echo "$CHANGED_FILES" | grep -qE "\.(spec|test)\.ts$"; then
            PROMPT+="

          ### Tests (Vitest / Bun:test / Playwright)

          **Pattern AAA obligatoire:**
          - Arrange: setup des donn√©es et mocks
          - Act: ex√©cution de l'action test√©e
          - Assert: v√©rification du r√©sultat

          **Principes (CRITIQUE):**
          - Tester le COMPORTEMENT, pas l'impl√©mentation
          - Tests lisibles = documentation vivante
          - Un test = un cas m√©tier clair
          - Helpers: \`createMock...()\` pour factory de donn√©es
          - Nommage: \`should [behavior] when [condition]\`
          - JAMAIS tester les d√©tails d'impl√©mentation (ordre d'appels, etc.)
          - JAMAIS de logique conditionnelle dans les tests"
          fi

          # Claude Code config (CLAUDE.md, .claude/)
          if echo "$CHANGED_FILES" | grep -qE "^(CLAUDE\.md|\.claude/)"; then
            PROMPT+="

          ### Claude Code Configuration

          **CLAUDE.md (CRITIQUE):**
          - Max ~150-200 instructions (au-del√†, Claude ignore les r√®gles)
          - Chaque ligne doit r√©pondre √†: 'Sans cette info, Claude ferait-il une erreur?'
          - JAMAIS de code snippets (deviennent obsol√®tes rapidement)
          - JAMAIS de secrets, cl√©s API, credentials
          - Utiliser \`@file.md\` pour importer du contenu externe
          - Privil√©gier les commandes bash, conventions, d√©cisions d'architecture

          **Rules (\`.claude/rules/\`):**
          - Frontmatter OBLIGATOIRE: \`description\` + \`paths\` (glob patterns)
          - Max 500 lignes par fichier
          - Une seule responsabilit√© par fichier (testing.md, api.md, etc.)
          - Nommage descriptif du fichier = son contenu
          - Organiser en sous-dossiers si n√©cessaire (frontend/, backend/)
          - JAMAIS de r√®gles sans \`paths\` (pollue le contexte global)

          **Commands/Skills (\`.claude/commands/\`, \`.claude/skills/\`):**
          - \`description\` OBLIGATOIRE (utilis√© pour auto-invocation)
          - \`disable-model-invocation: true\` pour workflows avec side effects
          - Garder les instructions concises et actionnables

          **Settings (\`.claude/settings.json\`):**
          - JAMAIS de secrets dans les settings
          - Deny rules pour fichiers sensibles: \`.env\`, \`.env.*\`, \`secrets/**\`
          - Patterns de permissions explicites (\`npm run:*\`, pas \`*\`)"
          fi

          PROMPT+="

          ## R√®gles transversales

          **Clean Code:**
          - Fonctions ‚â§30 lignes, fichiers ‚â§300 lignes
          - Nommage: \`isX\`/\`hasX\` pour bool√©ens, pluriel pour collections
          - Constantes nomm√©es (pas de magic numbers)
          - Code auto-document√© (pas de commentaires explicatifs)

          **TypeScript strict:**
          - JAMAIS \`any\` - utiliser \`unknown\` si incertain
          - JAMAIS \`as\` cast sans justification
          - Type guards pr√©f√©r√©s aux assertions

          **S√©curit√©:**
          - Pas de secrets hardcod√©s
          - JWT requis sur routes prot√©g√©es
          - Validation de tous les inputs externes

          ## Format de sortie (OBLIGATOIRE)

          Utilise EXACTEMENT ce format markdown:

          \`\`\`
          ## üîç Review PR #${{ github.event.pull_request.number }}

          **R√©sum√©:** üö® X bloquant(s) ¬∑ ‚ö†Ô∏è X important(s) ¬∑ üí° X suggestion(s)
          **Risque:** üü¢ Faible | üü° Moyen | üî¥ √âlev√© ¬∑ **Fichiers:** X

          ---

          ### üö® Bloquants (merge impossible)

          **\\\`fichier.ts:42\\\`** ‚Äî Titre court du probl√®me
          > Description et impact (pourquoi c'est critique)
          >
          > \\\`\\\`\\\`typescript
          > // Suggestion de fix
          > \\\`\\\`\\\`

          ---

          ### ‚ö†Ô∏è Importants

          **\\\`fichier.ts:15\\\`** ‚Äî Titre court
          > Description et suggestion de fix

          ---

          ### üí° Suggestions

          **\\\`fichier.ts:88\\\`** ‚Äî Am√©lioration possible
          > Suggestion

          ---

          ### ‚ú® Points positifs
          - Pattern X bien respect√©
          - Bonne pratique Y observ√©e

          ---

          **Verdict:** ‚úÖ APPROVE | ‚ùå CHANGES REQUESTED
          \`\`\`

          R√®gles:
          - R√©sum√© avec m√©triques EN PREMIER
          - Impact/Why pour chaque finding bloquant
          - Code snippets pour les fix complexes
          - Points positifs: reconna√Ætre les bonnes pratiques (min 1)
          - Max 10 issues total
          - En fran√ßais
          - UN SEUL commentaire (pas d'inline multiples)
          - Si aucun probl√®me: r√©sum√© \\\`0 issues\\\` + points positifs + verdict ‚úÖ"

          # Output using heredoc for multiline
          echo "review_prompt<<EOF" >> $GITHUB_OUTPUT
          echo "$PROMPT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Claude Code Review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: ${{ steps.prompt.outputs.review_prompt }}
          claude_args: |
            --max-turns 15
            --model claude-sonnet-4-5-20250929
            --allowedTools "Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh pr files:*)"
