name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize]
    paths:
      - 'frontend/**'
      - 'backend-nest/**'
      - 'shared/**'
      - 'supabase/**'
      - 'landing/**'
      - 'ios/**'
      - 'CLAUDE.md'
      - '.claude/**'

jobs:
  claude-review:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
      pull-requests: write
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Build review prompt
        id: prompt
        run: |
          set -e
          CHANGED_FILES=$(gh pr diff ${{ github.event.pull_request.number }} --name-only) || exit 1
          echo "Changed files:"
          echo "$CHANGED_FILES"

          # Detect stacks
          HAS_FRONTEND=false; HAS_BACKEND=false; HAS_LANDING=false
          HAS_IOS=false; HAS_SHARED=false; HAS_SUPABASE=false
          HAS_TESTS=false; HAS_CLAUDE_CONFIG=false

          echo "$CHANGED_FILES" | grep -q "^frontend/" && HAS_FRONTEND=true || true
          echo "$CHANGED_FILES" | grep -q "^backend-nest/" && HAS_BACKEND=true || true
          echo "$CHANGED_FILES" | grep -q "^landing/" && HAS_LANDING=true || true
          echo "$CHANGED_FILES" | grep -q "^ios/" && HAS_IOS=true || true
          echo "$CHANGED_FILES" | grep -q "^shared/" && HAS_SHARED=true || true
          echo "$CHANGED_FILES" | grep -q "^supabase/" && HAS_SUPABASE=true || true
          echo "$CHANGED_FILES" | grep -qE "\.(spec|test)\.ts$" && HAS_TESTS=true || true
          echo "$CHANGED_FILES" | grep -qE "^(CLAUDE\.md|\.claude/)" && HAS_CLAUDE_CONFIG=true || true

          # Build prompt in a temp file to avoid YAML indentation issues
          PROMPT_FILE=$(mktemp)
          cat > "$PROMPT_FILE" << 'ENDOFPROMPT'
          # Code Review - PR #NUM

          ## Ton role

          Tu es un reviewer exigeant mais juste. Ton objectif : proteger la codebase contre les vrais problemes, pas pointer chaque imperfection.

          ## Etape 1 : Charger le contexte projet

          AVANT de commencer la review, lis ces fichiers pour comprendre les conventions :
          1. `CLAUDE.md` (racine) - conventions generales, vocabulaire, stack
          2. Les fichiers `.claude/rules/` pertinents pour les stacks modifiees
          3. `memory-bank/systemPatterns.md` - architecture globale

          Ces fichiers sont ta source de verite. Ne suppose pas les conventions, lis-les.

          ## Etape 2 : Analyser le diff

          Lis le diff avec `gh pr diff NUM`.
          Pour chaque probleme potentiel, AVANT de le signaler :
          - Lis le fichier complet (pas seulement le diff) pour verifier le contexte
          - Verifie que le probleme existe reellement dans le code actuel
          - Si tu penses que des tests manquent, cherche dabord un fichier .spec.ts ou .test.ts existant

          ## Calibration des severites

          ### Bloquant (merge impossible)
          Problemes AVERES causant un dysfonctionnement. Exemples :
          - Crash runtime garanti (null access, type mismatch non gere)
          - Perte de donnees utilisateur
          - Faille de securite exploitable (secret expose, injection SQL, XSS)
          - Contrat API casse (shared schema incompatible frontend/backend)
          - Regression fonctionnelle demontrable

          ### Important
          Problemes reels avec impact mesurable. Exemples :
          - Erreur de logique metier (mauvais calcul, mauvaise condition)
          - Fuite memoire (subscription non nettoyee, event listener orphelin)
          - Violation architecture grave (import feature-to-feature, service dans ui/)
          - Donnees non validees avant envoi API

          ### Suggestion (max 3)
          Ameliorations avec benefice clair et demonstrable. Exemples :
          - Simplification significative du code (pas cosmetique)
          - Pattern du projet non suivi alors que le reste du codebase lutilise
          - Opportunite de reutiliser du code existant dans core/ ou pattern/

          ## NE PAS signaler (anti-bruit)

          - Preferences de style couvertes par le linter/formatter (le projet a `pnpm quality`)
          - Cas limites theoriques sans scenario de declenchement demonstrable
          - "Il faudrait ajouter des tests" sans verifier si des tests existent deja
          - Naming subjectif quand le nom actuel est comprehensible
          - Suggestions doptimisation sans preuve dun probleme de performance
          - Code pre-existant non modifie dans cette PR
          - Commentaires sur lordre des imports (gere par le formatter)
          - Complexite theorique : "ceci pourrait devenir un probleme si..."
          - Documentation manquante sauf si lAPI publique est incomprehensible sans
          ENDOFPROMPT

          # Stack-specific hints (lean)
          if [[ "$HAS_FRONTEND" == "true" ]]; then
            cat >> "$PROMPT_FILE" << 'ENDOFSTACK'

          ## Focus Angular
          Verifie : OnPush, signals (pas @Input/@Output), pas dimport feature-to-feature, @if/@for (pas *ngIf/*ngFor). Regle : `.claude/rules/03-frameworks-and-libraries/angular-signals.md`.
          ENDOFSTACK
          fi

          if [[ "$HAS_BACKEND" == "true" ]]; then
            cat >> "$PROMPT_FILE" << 'ENDOFSTACK'

          ## Focus NestJS
          Verifie : separation controller/service, DTOs via createZodDto(shared), pas de `any`, auth guards sur routes protegees.
          ENDOFSTACK
          fi

          if [[ "$HAS_LANDING" == "true" ]]; then
            cat >> "$PROMPT_FILE" << 'ENDOFSTACK'

          ## Focus Next.js
          Verifie : Server Components par defaut, `use client` si necessaire, next/image avec dimensions.
          ENDOFSTACK
          fi

          if [[ "$HAS_IOS" == "true" ]]; then
            cat >> "$PROMPT_FILE" << 'ENDOFSTACK'

          ## Focus iOS
          Verifie : @Observable (pas ObservableObject), actors pour services, async/await, pas de force unwrap. Regle : `.claude/rules/03-frameworks-and-libraries/swiftui.md`.
          ENDOFSTACK
          fi

          if [[ "$HAS_SHARED" == "true" ]]; then
            cat >> "$PROMPT_FILE" << 'ENDOFSTACK'

          ## Focus Shared
          Verifie : schemas Zod 4 (top-level validators) + types inferes, pas de dependances externes sauf zod.
          ENDOFSTACK
          fi

          if [[ "$HAS_SUPABASE" == "true" ]]; then
            cat >> "$PROMPT_FILE" << 'ENDOFSTACK'

          ## Focus Supabase
          Verifie : migrations idempotentes (IF NOT EXISTS, OR REPLACE), RLS policies avec user_id.
          ENDOFSTACK
          fi

          if [[ "$HAS_TESTS" == "true" ]]; then
            cat >> "$PROMPT_FILE" << 'ENDOFSTACK'

          ## Focus Tests
          Verifie : pattern AAA, tests de comportement (pas dimplementation), nommage should..when.
          ENDOFSTACK
          fi

          if [[ "$HAS_CLAUDE_CONFIG" == "true" ]]; then
            cat >> "$PROMPT_FILE" << 'ENDOFSTACK'

          ## Focus Config Claude
          Verifie : frontmatter paths dans rules, max 500 lignes par fichier, pas de secrets.
          ENDOFSTACK
          fi

          cat >> "$PROMPT_FILE" << 'ENDOFPUBLISH'

          ## Etape 3 : Publier la review

          ### Commentaires inline
          Pour chaque finding, utilise `mcp__github_inline_comment__create_inline_comment` sur la ligne exacte.
          Format :
          ```
          **[SEVERITE]** Titre court (confiance: X%)

          [Explication en 1-2 phrases du probleme et de son impact]

          [Suggestion de fix si non trivial]
          ```

          ### Commentaire resume
          Poste via `gh pr comment NUM --body "..."` :

          ```
          ## Review PR #NUM

          **Resume :** X bloquant(s) - Y important(s) - Z suggestion(s)

          ### Bloquants
          - `fichier.ts:L42` - Description (confiance: X%)

          ### Importants
          - `fichier.ts:L15` - Description (confiance: X%)

          ### Suggestions
          - `fichier.ts:L88` - Description (confiance: X%)

          ### Points positifs
          - [Bonne pratique observee]

          **Verdict :** APPROVE | CHANGES REQUESTED
          ```

          ## Regles finales

          - Confiance minimum 80% pour signaler un finding
          - Max 8 findings total. Priorise bloquants et importants.
          - Max 3 suggestions.
          - Chaque finding DOIT citer fichier:ligne exact et impact concret.
          - En francais.
          - Si aucun probleme : 0 issues + points positifs + APPROVE.
          - NE RETOURNE PAS le texte en message. Poste TOUT via les outils.
          ENDOFPUBLISH

          # Replace NUM placeholder with actual PR number
          sed -i "s/NUM/${{ github.event.pull_request.number }}/g" "$PROMPT_FILE"

          PROMPT=$(cat "$PROMPT_FILE")
          rm -f "$PROMPT_FILE"

          echo "review_prompt<<EOF" >> $GITHUB_OUTPUT
          echo "$PROMPT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Claude Code Review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: ${{ steps.prompt.outputs.review_prompt }}
          claude_args: |
            --max-turns 5
            --model claude-sonnet-4-5-20250929
            --allowedTools "mcp__github_inline_comment__create_inline_comment,Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh pr files:*),Read,Glob,Grep"
