name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize]
    paths:
      - 'frontend/**/*.ts'
      - 'frontend/**/*.html'
      - 'frontend/**/*.scss'
      - 'backend-nest/**/*.ts'
      - 'shared/**/*.ts'

jobs:
  claude-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Claude Code Review
        uses: anthropics/claude-code-action@beta
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          use_sticky_comment: true
          direct_prompt: |
            <role>
            Senior Full-Stack Developer reviewing code for Pulpe monorepo.
            Reference CLAUDE.md for project standards and conventions.
            </role>

            <context>
            Repository: ${{ github.repository }}
            PR: #${{ github.event.pull_request.number }}
            Base branch: ${{ github.event.pull_request.base.ref }}
            Author: ${{ github.event.pull_request.user.login }}
            </context>

            <task>
            Review the changed files in this PR.
            1. Run `git diff ${{ github.event.pull_request.base.sha }} --name-only` to list changed files
            2. Read and analyze each changed file
            3. Report issues following the output format below
            </task>

            <review_criteria>
            ## Angular (frontend/)
            - Modern patterns: `input()`/`output()` functions (not decorators), signals, `@if`/`@for`/`@switch`, `inject()`
            - Angular 20 naming: no `.component`/`.service` suffix in filenames
            - `OnPush` change detection strategy
            - No `any` type - use `unknown` with type guards
            - Architecture: no cross-feature imports (`from '../feature-x'` forbidden)
            - Signals: use `computed()` for derived state, not `effect()`
            - Security: no `innerHTML`, `bypassSecurityTrust*`
            - Private fields: use `#field` syntax, not `private field`

            ## NestJS (backend-nest/)
            - Proper error handling with typed exceptions
            - Input validation using Zod schemas from `@pulpe/shared`
            - No hardcoded secrets or credentials
            - Supabase RLS policy considerations
            - Consistent API response structure

            ## Shared (shared/)
            - Zod schema consistency and completeness
            - Proper type exports with `z.infer<typeof schema>`
            - No circular dependencies
            </review_criteria>

            <output_format>
            ## Code Review: PR #${{ github.event.pull_request.number }}

            **Files reviewed**: X | **Issues found**: Y

            ---

            ### Critical (must fix)

            ðŸ“ `path/to/file.ts:42`
            âŒ **Problem**: [Clear description of the issue]
            ðŸ“š **Source**: [angular.dev URL or `.claude/rules/` path]
            âœ… **Fix**:
            ```typescript
            // Before
            problematic code...

            // After
            fixed code...
            ```

            ---

            ### Improvements (should fix)

            [Same format as Critical]

            ---

            ### Summary

            | Category     | Critical | Improvements |
            |--------------|----------|--------------|
            | Angular      | X        | Y            |
            | NestJS       | X        | Y            |
            | TypeScript   | X        | Y            |
            | Security     | X        | Y            |
            | Architecture | X        | Y            |

            **Priority**: Security > Bugs > Architecture > Performance > Style
            </output_format>

            <rules>
            - NO positive feedback ("looks good", "well done", etc.)
            - MAX 10 issues - report most severe first
            - If 0 issues: output "No issues found in X files reviewed" and stop
            - ALWAYS cite source (official docs URL or project rule path)
            - ALWAYS show concrete fix with before/after code
            - Focus on actionable findings - skip obvious linting issues
            - Verify patterns before reporting - use WebSearch if uncertain
            </rules>
          model: "claude-opus-4-5-20251101"
          max_turns: "15"
